/*
========================================================================================
    Nextflow Configuration File
========================================================================================
*/

params {
    // Output
    run_name = 'benchmarking_run'
    outdir = "${launchDir}/${run_name}"
    
    // Required inputs
    fasta = null
    benchmark_vcf = null
    
    // Optional BAM inputs
    illumina_wes_bam = null
    illumina_wgs_bam = null
    pacbio_bam = null
    ont_bam = null
    
    // Optional target regions
    high_confidence_targets = null
    gene_panel_targets = null
    wes_utr_targets = null
    wes_sequencing_targets = null  // BED file for WES target regions (used by Manta --callRegions)
    tandem_repeats = null
    
    // Pipeline control
    skip_benchmarking = false
    skip_pbsv = false
    prepare_giab_resources = false
    prepare_complete_data = false
    
    // Truvari parameters
    truvari_refdist = 500
    truvari_pctsize = 0.7
    truvari_pctovl = 0
    truvari_pctseq = 0
    
    // Simulation (optional)
    simulate_targets = false
    num_simulations = 100
    gencode_gtf = null
    gather_statistics = false
    
    // Resources
    max_cpus = 24
    max_memory = '128.GB'
    max_time = '48.h'
    
    help = false
}

process {
    cpus = 1
    memory = 4.GB
    time = 4.h
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 1
    maxErrors = '-1'
    
    withLabel: 'process_low' {
        cpus = { check_max(2, 'cpus') }
        memory = { check_max(8.GB, 'memory') }
        time = { check_max(4.h, 'time') }
    }
    
    withLabel: 'process_medium' {
        cpus = { check_max(8, 'cpus') }
        memory = { check_max(32.GB, 'memory') }
        time = { check_max(8.h, 'time') }
    }
    
    withLabel: 'process_high' {
        cpus = { check_max(params.max_cpus, 'cpus') }
        memory = { check_max(64.GB, 'memory') }
        time = { check_max(12.h, 'time') }
    }
}

profiles {
    test { includeConfig 'conf/test.config' }
    test_nfcore { includeConfig 'conf/test_nfcore.config' }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        includeConfig 'conf/modules.config'
        process {
            withName: 'SIMULATE_TARGETS|GATHER_STATISTICS|CREATE_.*' {
                container = 'library://blazv/benchmark-sv/r-env:4-4-1'
            }
        }
    }
    
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        includeConfig 'conf/modules.config'
    }
}

manifest {
    name = 'sv-calling-pipeline'
    description = 'SV calling and benchmarking pipeline'
    mainScript = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version = '1.0.0'
}

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            return (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1) ? 
                params.max_memory as nextflow.util.MemoryUnit : obj
        } catch (all) { return obj }
    } else if (type == 'time') {
        try {
            return (obj.compareTo(params.max_time as nextflow.util.Duration) == 1) ? 
                params.max_time as nextflow.util.Duration : obj
        } catch (all) { return obj }
    } else if (type == 'cpus') {
        try { return Math.min(obj, params.max_cpus as int) }
        catch (all) { return obj }
    }
}

timeline.enabled = true
timeline.file = "${params.outdir}/pipeline_info/timeline.html"
report.enabled = true
report.file = "${params.outdir}/pipeline_info/report.html"
trace.enabled = true
trace.file = "${params.outdir}/pipeline_info/trace.txt"
