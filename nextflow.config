/*
========================================================================================
    Nextflow Configuration File
========================================================================================
*/

// Global default params
params {
    // Pipeline run name
    run_name = 'benchmarking_run'
    
    // Output directory
    outdir = "${launchDir}/${run_name}"
    
    // Reference files
    fasta = null
    
    // Input BAM files (optional - set as needed)
    illumina_wes_bam = null
    illumina_wgs_bam = null
    pacbio_bam = null
    ont_bam = null
    
    // Benchmarking files
    benchmark_vcf = null
    skip_benchmarking = false
    high_confidence_targets = null
    gene_panel_targets = null
    wes_utr_targets = null
    
    // Optional files
    tandem_repeats = null
    
    // Truvari parameters
    truvari_refdist = 500
    truvari_pctsize = 0.7
    truvari_pctovl = 0
    truvari_pctseq = 0
    
    // WES-specific Truvari parameters
    truvari_wes_refdist = 500
    truvari_wes_pctsize = 0.7
    truvari_wes_pctovl = 0
    truvari_wes_pctseq = 0
    
    // Resource defaults
    max_cpus = 24
    max_memory = '128.GB'
    max_time = '48.h'
    
    // Simulation parameters (optional features)
    simulate_targets = false
    num_simulations = 100
    gencode_gtf = null
    
    // Statistics and plotting (optional features)
    gather_statistics = false
    
    // Help message
    help = false
}

// Process configuration
process {
    // Default resources
    cpus = 1
    memory = 4.GB
    time = 4.h
    
    // Error strategy
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 2
    maxErrors = '-1'
    
    // Process-specific resources (nf-core modules use their own containers)
    withName: 'MANTA_GERMLINE' {
        cpus = { check_max(8, 'cpus') }
        memory = { check_max(32.GB, 'memory') }
        time = { check_max(12.h, 'time') }
        publishDir = [
            path: { "${params.outdir}/calls/${task.ext.technology ?: 'unknown'}/sv/manta" },
            mode: 'copy',
            pattern: '*.{vcf.gz,vcf.gz.tbi}'
        ]
    }
    
    withName: 'CUTESV_.*' {
        cpus = { check_max(params.max_cpus, 'cpus') }
        memory = { check_max(64.GB, 'memory') }
        time = { check_max(8.h, 'time') }
    }
    
    withName: 'PBSV_DISCOVER' {
        cpus = 1
        memory = { check_max(8.GB, 'memory') }
        time = { check_max(4.h, 'time') }
    }
    
    withName: 'PBSV_CALL' {
        cpus = { check_max(params.max_cpus, 'cpus') }
        memory = { check_max(32.GB, 'memory') }
        time = { check_max(8.h, 'time') }
    }
    
    withName: 'SNIFFLES' {
        cpus = { check_max(params.max_cpus, 'cpus') }
        memory = { check_max(32.GB, 'memory') }
        time = { check_max(8.h, 'time') }
        publishDir = [
            path: { "${params.outdir}/calls/${task.ext.technology ?: 'unknown'}/sv/sniffles" },
            mode: 'copy',
            pattern: '*.{vcf.gz,vcf.gz.tbi}'
        ]
    }
    
    withName: 'BGZIP_TABIX.*' {
        cpus = 2
        memory = 4.GB
        time = 2.h
        publishDir = [
            path: { "${params.outdir}/calls/${task.ext.technology ?: 'unknown'}/sv/${task.ext.tool_lc ?: 'unknown'}" },
            mode: 'copy',
            pattern: '*.{vcf.gz,vcf.gz.tbi}'
        ]
    }
    
    withName: 'TRUVARI_BENCH' {
        cpus = 2
        memory = { check_max(16.GB, 'memory') }
        time = { check_max(4.h, 'time') }
    }
    
    
    withName: 'SAMTOOLS_FAIDX' {
        cpus = 1
        memory = 2.GB
        time = 1.h
    }
    
    withName: 'BEDTOOLS_INTERSECT' {
        cpus = 1
        memory = 4.GB
        time = 1.h
    }
    
    withName: 'GUNZIP' {
        cpus = 1
        memory = 2.GB
        time = 1.h
    }
}

// Execution profiles
profiles {
    // Test profiles
    test {
        includeConfig 'conf/test.config'
    }
    
    test_nfcore {
        includeConfig 'conf/test_nfcore.config'
    }
    
    // Container engine profiles
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.runOptions = '--cleanenv'
        includeConfig 'conf/modules.config'
    }
    
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
        includeConfig 'conf/modules_docker.config'
    }
    
    // Executor profiles
    local {
        process.executor = 'local'
    }
    
    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'
    }
}

// Manifest
manifest {
    name = 'sv-calling-pipeline'
    author = 'Your Name'
    description = 'Structural variant calling and benchmarking pipeline for multiple sequencing technologies'
    mainScript = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version = '1.0.0'
}

// Function to ensure that resource requirements don't go beyond maximum limit
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Trace and timeline reports
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}
