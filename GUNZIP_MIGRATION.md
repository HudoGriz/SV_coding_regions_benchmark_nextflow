# Gunzip Module Migration to nf-core

## Summary
Successfully replaced local `gunzip` module with nf-core `gunzip` module across all workflow files.

## Changes Made

### 1. Updated Workflow Files

#### workflows/preparation/prepare_data_complete_grch37.nf
- ✅ Already updated to use `../../modules/nf-core/gunzip/main`
- ✅ Process calls properly use tuple format
- ✅ Output references use `.out.gunzip` with `.map` to extract file

#### workflows/preparation/prepare_data_complete_grch38.nf
- ✅ Updated process call to match nf-core signature
- ✅ Added proper channel construction with `.map`
- ✅ Updated output references from `.out.file` to `.out.gunzip.map { meta, file -> file }`

### 2. Configuration Updates

#### nextflow.config
- ✅ Added publishDir configuration for GUNZIP process
- ✅ Configured to respect `params.publish_gunzip` flag
- ✅ Set output to `${params.references_dir}`

## Key Differences Between Local and nf-core Modules

### Local Module (gunzip.nf)
```groovy
input:
path archive
val publishDir

output:
path "${output_name}", emit: file

script:
output_name = archive.name.replaceAll(/\.gz$/, '')
"""
gunzip -c ${archive} > ${output_name}
"""
```

### nf-core Module (gunzip/main.nf)
```groovy
input:
tuple val(meta), path(archive)

output:
tuple val(meta), path("${gunzip}"), emit: gunzip
path "versions.yml", emit: versions

script:
def prefix = task.ext.prefix ?: name
gunzip = prefix + ".${extension}"
"""
gzip -cd ${args} ${archive} > ${gunzip}

cat <<-END_VERSIONS > versions.yml
"${task.process}":
    gunzip: \$(echo \$(gunzip --version 2>&1) | sed 's/^.*(gzip) //; s/ Copyright.*\$//')
END_VERSIONS
"""
```

## Process Call Updates

### Before (local module):
```groovy
GUNZIP(
    DOWNLOAD_REFERENCE.out.file,
    references_dir
)

// Use output
SAMTOOLS_FAIDX(GUNZIP.out.file)
reference_fasta = GUNZIP.out.file
```

### After (nf-core module):
```groovy
// Create channel with meta map
ch_gunzip_ref = DOWNLOAD_REFERENCE.out.file
    .map { fasta -> [[id: 'GRCh38'], fasta] }

GUNZIP(ch_gunzip_ref)

// Use output (extract file from tuple)
SAMTOOLS_FAIDX(GUNZIP.out.gunzip)
reference_fasta = GUNZIP.out.gunzip.map { meta, file -> file }
```

## Benefits of Migration

1. **No Local Containers**: nf-core modules use standard containers from public registries
2. **Version Tracking**: Built-in `versions.yml` output for reproducibility
3. **Better File Handling**: Uses `gzip -cd` instead of `gunzip -c` to avoid permission issues
4. **Standardization**: Follows nf-core best practices and conventions
5. **Flexible Naming**: Supports `task.ext.prefix` for custom output naming
6. **Maintainability**: Can be updated via `nf-core modules update gunzip`

## Configuration Options

The nf-core GUNZIP module supports:

```groovy
process {
    withName: 'GUNZIP' {
        // Custom output prefix (optional)
        ext.prefix = 'custom_name'
        
        // Additional gzip arguments (optional)
        ext.args = ''
        
        // Publishing options
        publishDir = [
            path: { "${params.references_dir}" },
            mode: 'copy',
            enabled: params.publish_gunzip
        ]
    }
}
```

## Testing Recommendations

Test the changes with:
```bash
# Test GRCh37 reference download and gunzip
nextflow run main.nf -profile complete_grch37 \
    --prepare_complete_data true \
    --skip_bam_download true \
    --skip_singularity_download true

# Test GRCh38 reference download and gunzip
nextflow run main.nf -profile complete_grch38 \
    --prepare_complete_data true \
    --skip_bam_download true
```

## Files That Can Be Removed

The following local module file is no longer referenced and can be removed:
- `modules/local/gunzip.nf`

## Migration Status
- ✅ bedtools - **COMPLETED** (PR #1)
- ✅ gunzip - **COMPLETED** (this PR)
- ⏳ tabix - Planned
- ⏳ samtools - Planned

## Technical Notes

### Why `.map { meta, file -> file }` in emit?

The nf-core GUNZIP outputs a tuple `[meta, file]`, but downstream processes or workflow outputs may expect just the file. The `.map` operation extracts only the file from the tuple:

```groovy
// nf-core output is tuple
GUNZIP.out.gunzip  // [[id: 'GRCh38'], file.fasta]

// Extract just the file
GUNZIP.out.gunzip.map { meta, file -> file }  // file.fasta
```

This is only needed when:
1. Emitting from the workflow
2. Passing to processes that don't expect tuples

For process-to-process communication within the workflow, the full tuple can be used directly.

---

Generated by Seqera AI
