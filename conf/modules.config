/*
========================================================================================
    Module configuration
========================================================================================
    This file configures process-specific settings and container overrides.
    Container overrides are necessary because some nf-core modules have incorrect
    container paths (e.g., biocontainers/tool instead of quay.io/biocontainers/tool)
========================================================================================
*/

process {
    // Fix container paths and add process-specific configuration
    // withName: 'SAMTOOLS_.*' {
    //     container = 'quay.io/biocontainers/samtools:1.19.2--h50ea8bc_1'
    // }
    
    withName: 'MANTA_WES' {
        // container = 'quay.io/biocontainers/manta:1.6.0--h9ee0642_1'
        ext.args = '--exome'  // Turn off depth filters for WES data
        publishDir = [
            path: { "${params.outdir}/sv_calls/Illumina_WES/Manta" },
            mode: 'copy',
            saveAs: { filename -> 
                if (filename.endsWith('.vcf.gz') || filename.endsWith('.vcf.gz.tbi')) {
                    filename
                } else if (filename.equals('versions.yml')) {
                    null
                } else {
                    filename
                }
            }
        ]
    }
    
    withName: 'MANTA_WGS' {
        // container = 'quay.io/biocontainers/manta:1.6.0--h9ee0642_1'
        publishDir = [
            path: { "${params.outdir}/sv_calls/Illumina_WGS/Manta" },
            mode: 'copy',
            saveAs: { filename -> 
                if (filename.endsWith('.vcf.gz') || filename.endsWith('.vcf.gz.tbi')) {
                    filename
                } else if (filename.equals('versions.yml')) {
                    null
                } else {
                    filename
                }
            }
        ]
    }
    
    // withName: 'PBSV_.*' {
    //     container = 'quay.io/biocontainers/pbsv:2.9.0--h9ee0642_0'
    // }
    
    withName: 'PBSV_DISCOVER' {
        memory = '64.GB'
        publishDir = [
            path: { "${params.outdir}/sv_calls/PacBio/PBSV" },
            mode: 'copy',
            pattern: '*.svsig.gz',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'PBSV_CALL' {
        publishDir = [
            path: { "${params.outdir}/sv_calls/PacBio/PBSV" },
            mode: 'copy',
            pattern: '*.vcf',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'SNIFFLES' {
        // container = 'quay.io/biocontainers/sniffles:2.2--pyhdfd78af_0'
        publishDir = [
            path: { "${params.outdir}/sv_calls/ONT/Sniffles" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'CUTESV_PACBIO' {
        // container = 'quay.io/biocontainers/cutesv:2.0.3--pyhdfd78af_0'
        publishDir = [
            path: { "${params.outdir}/sv_calls/PacBio/CuteSV" },
            mode: 'copy',
            pattern: '*.vcf',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'CUTESV_ONT' {
        // container = 'quay.io/biocontainers/cutesv:2.0.3--pyhdfd78af_0'
        publishDir = [
            path: { "${params.outdir}/sv_calls/ONT/CuteSV" },
            mode: 'copy',
            pattern: '*.vcf',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'TRUVARI_BENCH' {
        ext.args = { "--passonly --dup-to-ins ${meta.truvari_args ?: ''}" }
        ext.prefix = { "${meta.technology}_${meta.tool}_${meta.target}" }
        publishDir = [
            path: { "${params.outdir}/real_intervals/${meta.technology}/truvari/${meta.tool}/${meta.target}" },
            mode: 'copy',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    // withName: 'BGZIP_TABIX.*' {
    //     container = 'community.wave.seqera.io/library/htslib:1.21--ff8e28a189fbecaa'
    // }

    withName: 'BGZIP_TABIX_CUTESV_PACBIO' {
        ext.args2 = '-p vcf'
        publishDir = [
            path: { "${params.outdir}/sv_calls/PacBio/CuteSV" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'BGZIP_TABIX_CUTESV_ONT' {
        ext.args2 = '-p vcf'
        publishDir = [
            path: { "${params.outdir}/sv_calls/ONT/CuteSV" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: 'BGZIP_TABIX_PBSV' {
        ext.args2 = '-p vcf'
        publishDir = [
            path: { "${params.outdir}/sv_calls/PacBio/PBSV" },
            mode: 'copy',
            pattern: '*.vcf.gz*',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    // withName: 'BEDTOOLS_.*' {
    //     container = 'quay.io/biocontainers/bedtools:2.31.1--hf5e1c6e_0'
    // }
    
    // withName: 'GUNZIP' {
    //     container = 'quay.io/biocontainers/gzip:1.12'
    // }
    
    // withName: 'SIMULATE_TARGETS|GATHER_STATISTICS' {
    //     container = 'rocker/tidyverse:4.4.1'
    // }
    
    // withName: 'DOWNLOAD_.*' {
    //     container = 'quay.io/biocontainers/samtools:1.19.2--h50ea8bc_1'
    // }
    
    // withName: 'CREATE_.*' {
    //     container = 'rocker/tidyverse:4.4.1'
    // }
}
